import { Constants, Translations } from "../constants.slint";
import { DeckNode, CardNode } from "../types.slint";
import { Button, ListView, ScrollView } from "std-widgets.slint";
import { RatingButton } from "../components/rating_button.slint";

component Menu {
    in property <CardNode> card;
    callback home_clicked();

    HorizontalLayout {
        padding-bottom: Constants.padding_standard;
        HorizontalLayout {
            horizontal-stretch: 1;
            alignment: start;
            TouchArea {

                Image {
                    source: @image-url("../icons/home.svg");
                }

                clicked => {
                    home_clicked();
                }
            }
        }

        HorizontalLayout {
            spacing: Constants.spacing_standard;

            Text {
                text: card.deck.new;
                font-family: Constants.font_family_standard;
                color: #0000FF;
                font-size: Constants.font_size_subcontent;
                vertical-alignment: center;
            }

            Text {
                text: card.deck.learn;
                font-family: Constants.font_family_standard;
                color: #FF0000;
                font-size: Constants.font_size_subcontent;
                vertical-alignment: center;
            }

            Text {
                text: card.deck.due;
                font-family: Constants.font_family_standard;
                color: #008000;
                font-size: Constants.font_size_subcontent;
                vertical-alignment: center;
            }
        }

        HorizontalLayout {
            horizontal-stretch: 1;
            alignment: end;
        }
    }
}

export component LearnScreen {
    in property <Translations> tr;
    in property <CardNode> card;
    in-out property <bool> show_answer;
    property <bool> valid_deck: card.id != (-1 * 1ms) && card.answer != [];
    property <[string]> pages: show_answer ? card.answer : card.question;
    out property <int> current-page: 0;
    property <int> total-pages: pages.length;

    changed total-pages => {
        if current-page > total-pages {
            current-page = 0;
        }
    }

    callback home_clicked();
    callback rate(rating: int);

    forward-focus: focus-scope;

    focus-scope := FocusScope {
        key-pressed(event) => {
            if valid_deck {
                if current-page > 0 && (event.text == Key.LeftArrow || event.text == Key.DownArrow || event.text == Key.PageDown) {
                    current-page -= 1;
                    accept
                } else if current-page < total-pages - 1 && (event.text == Key.RightArrow || event.text == Key.UpArrow || event.text == Key.PageUp) {
                    current-page += 1;
                    accept
                } else if !show_answer && (current-page == total-pages - 1 || current-page == 0) {
                    show_answer = true;
                    accept
                } else if show_answer && (current-page == total-pages - 1 || current-page == 0) {
                    if event.text == Key.LeftArrow || event.text == Key.DownArrow || event.text == Key.PageDown {
                        rate(0);
                        show_answer = false;

                        accept
                    } else if event.text == Key.RightArrow || event.text == Key.Return {
                        rate(1);
                        show_answer = false;

                        accept
                    } else if event.text == Key.Menu || event.text == Key.UpArrow || event.text == Key.PageUp {
                        rate(2);
                        show_answer = false;

                        accept
                    }
                }
            }
            reject
        }

        VerticalLayout {
            VerticalLayout {
                alignment: start;
                Menu {
                    card: card;
                    home_clicked => {
                        home_clicked();
                    }
                }

                sgr := SwipeGestureHandler {
                    handle-swipe-down: current-page > 0;
                    handle-swipe-up: current-page < total-pages - 1;
                    swiped => {
                        if self.current-position.y > self.pressed-position.y + self.height / 4 {
                            if current-page > 0 {
                                current-page -= 1;
                            }
                        } else if self.current-position.y < self.pressed-position.y - self.height / 4 {
                            if current-page < total-pages - 1 {
                                current-page += 1;
                            }
                        }
                    }

                    VerticalLayout {
                        Text {
                            text: (current-page < pages.length ? pages[current-page] : "") + (pages.length > 1 ? "\n\n[" + (current-page + 1) + "/" + total-pages + "]" : "");
                            font-family: Constants.font_family_standard;
                            font-size: Constants.font_size_content;
                            wrap: TextWrap.word-wrap;
                            overflow: TextOverflow.clip;
                            vertical-alignment: center;
                            horizontal-alignment: center;
                        }
                    }
                }
            }

            if valid_deck: VerticalLayout {
                alignment: end;
                HorizontalLayout {
                    alignment: center;
                    padding-top: Constants.padding_standard;

                    if !show_answer: Button {
                        width: self.preferred-width * 2;
                        height: self.preferred-height * 2;
                        text: tr.show-answer;

                        clicked => {
                            show_answer = true;
                        }
                    }

                    if show_answer: HorizontalLayout {
                        spacing: Constants.spacing_medium;
                        for rating in 4: RatingButton {
                            duration: card.durations[rating];
                            label: rating == 0 ? tr.again : rating == 1 ? tr.hard : rating == 2 ? tr.good : tr.easy;
                            color: rating == 0 ? #FF0000 : rating == 2 ? #008000 : rating == 3 ? #0000FF : #000000;

                            clicked => {
                                rate(rating);
                                show_answer = false;
                            }
                        }
                    }
                }
            }
        }
    }
}
